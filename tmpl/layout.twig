<!-- index.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Claire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff3cac">
    <link rel="icon" href="{{ base_url }}/image/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ base_url }}/css/style.css">
</head>
<body class="{{ (layout_mode|default('full')) == 'compact' ? 'compact' : '' }}">
<div class="app">
    {% block app %}{% endblock %}

    <!-- Backdrop pour le panneau d'options (fermeture au clic en dehors) -->
    <div class="options-backdrop" id="optionsBackdrop" aria-hidden="true"></div>

    <aside class="options-panel" id="optionsPanel">
        <button
                class="options-close"
                type="button"
                aria-label="Fermer le panneau d’options"
                title="Fermer"
        >
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
        <div class="options-panel__section">
            <span class="options-panel__title">Conversations</span>
            <div
                class="options-item"
                role="button"
                tabindex="0"
                hx-post="{{ base_url }}/history/new"
                hx-target="#messages"
                hx-swap="innerHTML"
                hx-on:keydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); this.click(); }"
                hx-on::after-request="
                    if (event.detail.successful) {
                        // Ferme le panneau d'options
                        const panel = document.getElementById('optionsPanel');
                        const bd = document.getElementById('optionsBackdrop');
                        const toggle = document.querySelector('.options-toggle');
                        if (panel) panel.classList.remove('is-open');
                        if (bd) bd.classList.remove('is-visible');
                        if (toggle) toggle.classList.remove('is-active');

                        // Scroll en bas
                        const chatBody = document.querySelector('.chat-body');
                        if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;

                        // Rafraîchir le compteur
                        const countUrl = '{{ base_url }}/history/count';
                        if (window.htmx) { htmx.ajax('GET', countUrl, {target: '#historyCountBadge', swap: 'innerHTML'}); }
                    }
                "
            >
                <span class="options-item__label">Nouvelle conversation</span>
            </div>
            <div class="options-list">
                <div
                        class="options-item"
                        id="historyToggle"
                        role="button"
                        tabindex="0"
                        aria-expanded="false"
                        aria-controls="historyList"
                >
                    <span class="options-item__label">Historique des conversations</span>
                    <span
                            class="options-item__badge"
                            id="historyCountBadge"
                            hx-get="{{ base_url }}/history/count"
                            hx-trigger="load"
                            hx-swap="innerHTML"
                    >0</span>
                </div>
                <div id="historyList" class="options-subpanel" aria-live="polite" style="margin: 0 16px 8px;"></div>
            </div>
        </div>

        <div class="options-panel__section">
            <span class="options-panel__title">Données</span>
            <div class="options-list">
                <div
                        class="options-item"
                        id="filesToggle"
                        role="button"
                        tabindex="0"
                        aria-expanded="false"
                        aria-controls="filesList"
                >
                    <span class="options-item__label">Fichiers</span>
                    <span
                            class="options-item__badge"
                            id="filesCountBadge"
                            hx-get="{{ base_url }}/files/count"
                            hx-trigger="load"
                            hx-swap="innerHTML"
                    >0</span>
                </div>
                <div id="filesList" class="options-subpanel files-root" aria-live="polite" style="margin: 0 16px 8px;"></div>
            </div>

            <div class="options-list">
                <div
                        class="options-item"
                        id="ragToggle"
                        role="button"
                        tabindex="0"
                        aria-expanded="false"
                        aria-controls="ragPanel"
                        data-open-upload-dialog
                        data-upload-context="rag"
                >
                    <span class="options-item__label">Documents RAG</span>
                </div>
            </div>
        </div>

        <div class="options-panel__section">
            <span class="options-panel__title">Préférences</span>
            <div class="options-list">
                <div class="options-item" id="toggleStreamMode" role="button" tabindex="0"
                     aria-pressed="false"
                     data-chat-mode="{{ chat_mode|default('chat') }}"
                >
                    <span class="options-item__label">Réponse en continue</span>
                    <span class="options-item__badge" data-mode-badge>
                        {{ (chat_mode|default('chat')) == 'stream' ? 'On' : 'Off' }}
                    </span>
                </div>
                <div class="options-item">
                    <label for="brainSelector" class="options-item__label" style="cursor: pointer;">Assistant</label>
                    <span class="options-item__badge" style="padding: 0; background: transparent; box-shadow: none;">
                        <select id="brainSelector" name="brain"
                                style="
                                    appearance: none;
                                    -webkit-appearance: none;
                                    -moz-appearance: none;
                                    background: var(--bg-input);
                                    border: 1px solid var(--border);
                                    border-radius: 10px;
                                    padding: 6px 28px 6px 10px;
                                    font: inherit;
                                    color: inherit;
                                    cursor: pointer;
                                    min-width: 140px;
                                "
                        >
                            {% for b in brains|default([]) %}
                                <option value="{{ b.slug }}" {{ (current_brain|default('claire')) == b.slug ? 'selected' : '' }}>
                                    {{ b.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </span>
                </div>
                <div
                        class="options-item"
                        id="toggleLayoutMode"
                        data-layout-toggle
                        data-layout-mode="{{ layout_mode|default('full') }}"
                >
                    <span class="options-item__label">Mode largeur</span>
                    <span class="options-item__badge" data-layout-badge>
                        {{ (layout_mode|default('full')) == 'compact' ? 'Largeur 800px' : 'Plein écran' }}
                    </span>
                </div>
            </div>
        </div>

        <div class="options-panel__section">
            <span class="options-panel__title">Compte</span>
            <div class="options-list">
                {% if uinfo is defined and uinfo %}
                <div class="options-item" aria-current="true">
                    <span class="options-item__label">{{ uinfo.name }}</span>
                </div>
                {% endif %}
                <div
                        class="options-item"
                        role="button"
                        tabindex="0"
                        hx-on:click="window.location='{{ base_url }}/logout'"
                        hx-on:keydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); this.click(); }"
                >
                    <span class="options-item__label">Se déconnecter</span>
                </div>
            </div>
        </div>
    </aside>

    {# Global reusable modal dialog #}
    <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true"></div>
    <div id="modalRoot" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle" aria-describedby="modalBody" data-variant="default">
        <div class="modal__container">
            <div class="modal__header">
                <h2 id="modalTitle" class="modal__title">Confirmation</h2>
                <button id="modalClose" class="modal__close" type="button" aria-label="Fermer la boîte de dialogue" title="Fermer">
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
            </div>
            <div id="modalBody" class="modal__body">Êtes-vous sûr ?</div>
            <div class="modal__footer">
                <button id="modalCancel" class="btn btn--secondary" type="button">Annuler</button>
                <button id="modalConfirm" class="btn btn--primary" type="button">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ base_url }}/js/htmx.min.js"></script>
<script src="{{ base_url }}/js/htmx-stream.js"></script>
{% block script %}{% endblock %}
<!-- Global fixed tooltip banner (bottom of the page) -->
<div id="historyTooltipBanner" role="status" aria-live="polite" aria-hidden="true"></div>
<script>
    // Gestion fermeture du panneau d'options (bouton, touche Échap, clic sur backdrop)
    (function() {
        const panel = document.getElementById('optionsPanel');
        const closeBtn = panel ? panel.querySelector('.options-close') : null;
        const toggleBtn = document.querySelector('.options-toggle');
        const backdrop = document.getElementById('optionsBackdrop');
        if (!panel || !closeBtn || !toggleBtn) return;

        function closePanel(focusToggle = true) {
            panel.classList.remove('is-open');
            toggleBtn.classList.remove('is-active');
            toggleBtn.setAttribute('aria-expanded', 'false');
            if (backdrop) { backdrop.classList.remove('is-visible'); }
            if (focusToggle) {
                try { toggleBtn.focus(); } catch (e) {}
            }
        }

        closeBtn.addEventListener('click', function() { closePanel(true); });
        if (backdrop) {
            backdrop.addEventListener('click', function() { closePanel(true); });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.key === 'Esc') {
                if (panel.classList.contains('is-open')) {
                    e.preventDefault();
                    closePanel(true);
                }
            }
        });

        // Si le panneau est ouvert par un autre moyen, s'assurer que aria-expanded est correct
        const observer = new MutationObserver(function() {
            const isOpen = panel.classList.contains('is-open');
            toggleBtn.setAttribute('aria-expanded', String(isOpen));
            if (backdrop) { backdrop.classList.toggle('is-visible', isOpen); }
        });
        observer.observe(panel, { attributes: true, attributeFilter: ['class'] });
    })();

    // Sélecteur d'assistant (N assistants)
    (function() {
        const sel = document.getElementById('brainSelector');
        if (!sel) return;
        sel.addEventListener('change', async function() {
            const val = sel.value;
            try {
                await fetch('{{ base_url }}/config/brain_avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ avatar: val }).toString(),
                });
            } catch (e) {
                console.error(e);
            }
            // Recharger pour appliquer l'avatar/nom/description
            window.location.reload();
        });
    })();

    // Toggle « Documents RAG »: ouvre/ferme simplement le panneau avec le formulaire (pas de liste ni compteur)
    (function () {
        const btn = document.getElementById('ragToggle');
        const panel = document.getElementById('ragPanel');
        if (!btn || !panel) return;

        function isExpanded() { return btn.getAttribute('aria-expanded') === 'true'; }
        function expand() { btn.setAttribute('aria-expanded', 'true'); panel.style.display = ''; }
        function collapse() { btn.setAttribute('aria-expanded', 'false'); panel.style.display = 'none'; }
        function toggle() { if (isExpanded()) { collapse(); } else { expand(); } }

        btn.addEventListener('click', function () { toggle(); });
        btn.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); } });
    })();

    // Boîte de dialogue d'upload (réutilisable pour Fichiers et RAG)
    (function() {
        const root = document;
        const dlg = (function createDialog(){
            // Crée le DOM une seule fois
            let existing = root.getElementById('uploadDialog');
            if (existing) return existing;
            const wrap = root.createElement('div');
            wrap.id = 'uploadDialog';
            wrap.setAttribute('role', 'dialog');
            wrap.setAttribute('aria-modal', 'true');
            wrap.setAttribute('aria-hidden', 'true');
            wrap.style.cssText = 'position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;';
            wrap.innerHTML = `
                <div class="dialog-backdrop" data-upload-backdrop></div>
                <div class="dialog-panel" role="document">
                    <div style="display:flex; align-items:center; gap:12px; padding:14px 18px; border-bottom:1px solid rgba(0,0,0,.08);">
                        <div id="uploadDialogTitle" class="options-panel__title" style="font-size:17px;">Téléverser un fichier</div>
                    </div>
                    <form id="uploadDialogForm"
                        style="padding:18px; display:flex; flex-direction:column; gap:14px;"
                        hx-post="{{ base_url }}/files/upload_rag"
                        hx-encoding="multipart/form-data"
                        hx-indicator="#filesRagUploadIndicator"
                        >
                        <div id="filesRagUploadIndicator" class="htmx-indicator" aria-hidden="true"
                             style="position:absolute; inset:0; display:none; background:rgba(8,0,14,0.55); backdrop-filter:blur(2px); border-radius:10px; align-items:center; justify-content:center; z-index:5;">
                            <div style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:rgba(30,0,50,0.9); border:1px solid rgba(255,255,255,0.08); border-radius:999px; box-shadow:0 10px 26px rgba(26,0,41,0.35);">
                                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" style="color:#ff7ce5;">
                                    <path d="M7 2h10v4a5 5 0 0 1-2.1 4.1L12 12l2.9 1.9A5 5 0 0 1 17 18v4H7v-4a5 5 0 0 1 2.1-4.1L12 12l-2.9-1.9A5 5 0 0 1 7 6V2z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                                    <path d="M8 4h8M8 20h8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                                </svg>
                                <span style="color:#fff0fe; font-size:14px;">Téléversement et vectorisation en cours…</span>
                            </div>
                        </div>
                        <div class="upload-field" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <input type="file" name="file" id="uploadDialogInput"
                                   accept="{{ settings.get('files.upload.acceptedExt') }}" required
                                   style="position:absolute; left:-10000px; width:1px; height:1px; overflow:hidden;" />
                            <label for="uploadDialogInput" class="btn dialog-panel-btn" aria-label="Parcourir" title="Parcourir…">Parcourir…</label>
                            <span id="uploadDialogFileName" style="min-width:180px; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color: wheat;" aria-live="polite">Aucun fichier sélectionné</span>
                        </div>
                        <div style="font-size:12px; color:#666;">Extensions autorisées: {{ settings.get('files.upload.acceptedExt') }}</div>
                        <div style="display:flex; gap:8px; justify-content:flex-end;">
                            <button type="button" class="btn dialog-panel-btn" data-upload-cancel>Annuler</button>
                            <button type="submit" class="btn btn--primary" data-upload-submit disabled>Envoyer</button>
                        </div>
                    </form>
                </div>`;
            root.body.appendChild(wrap);
            return wrap;
        })();

        const form = dlg.querySelector('#uploadDialogForm');
        const input = dlg.querySelector('#uploadDialogInput');
        const btnClose = dlg.querySelector('[data-upload-close]');
        const btnCancel = dlg.querySelector('[data-upload-cancel]');
        const backdrop = dlg.querySelector('[data-upload-backdrop]');
        const title = dlg.querySelector('#uploadDialogTitle');

        function openDialog(ctx) {
            // Nettoyage
            input.value = '';
            // Retire attributes hx spécifiques précédents
            form.removeAttribute('hx-target');
            form.setAttribute('hx-swap', 'none');

            // Enlever anciens écouteurs htmx
            // Utilise un contrôleur simple via propriété
            form.__ctx = ctx;

            // Configure selon contexte
            if (ctx === 'files') {
                title.textContent = 'Téléverser un fichier';
                form.setAttribute('hx-post', '{{ base_url }}/files/upload');
                form.setAttribute('hx-target', '#filesList');
                form.setAttribute('hx-swap', 'innerHTML');
                // Fermer après swap + rafraîchir badge
                const onAfter = function() {
                    try { if (window.htmx) { window.htmx.ajax('GET', '{{ base_url }}/files/count', {target:'#filesCountBadge', swap:'innerHTML'}); } } catch(_){ }
                    closeDialog();
                };
                form.addEventListener('htmx:afterOnLoad', onAfter, { once: true });
            } else {
                title.textContent = 'Téléverser un document RAG';
                form.setAttribute('hx-post', '{{ base_url }}/rag/upload');
                form.setAttribute('hx-swap', 'none');
                const onAfterReq = function() {
                    // Feedback léger côté RAG
                    try {
                        var fb = document.getElementById('ragUploadFeedback');
                        if (fb) { fb.textContent = 'Fichier envoyé'; fb.style.opacity = '1'; setTimeout(function(){ fb.style.opacity = '0'; }, 1800); }
                    } catch(_) {}
                    closeDialog();
                };
                form.addEventListener('htmx:afterRequest', onAfterReq, { once: true });
            }

            dlg.style.display = 'flex';
            dlg.setAttribute('aria-hidden', 'false');
            const submitBtn = dlg.querySelector('[data-upload-submit]');
            if (submitBtn) submitBtn.disabled = true;
            setTimeout(function(){ const label = dlg.querySelector('label[for="uploadDialogInput"]'); (label||input).focus(); }, 0);
        }

        function closeDialog() {
            dlg.style.display = 'none';
            dlg.setAttribute('aria-hidden', 'true');
        }

        // Ouvrir via boutons avec data-open-upload-dialog
        root.addEventListener('click', function(e){
            const btn = e.target.closest && e.target.closest('[data-open-upload-dialog]');
            if (!btn) return;
            const ctx = btn.getAttribute('data-upload-context') === 'rag' ? 'rag' : 'files';
            openDialog(ctx);
        });

        // Fermer
        [btnClose, btnCancel, backdrop].forEach(function(el){ if (el) el.addEventListener('click', closeDialog); });
        root.addEventListener('keydown', function(e){ if (e.key === 'Escape' && dlg.style.display !== 'none') { e.preventDefault(); closeDialog(); } });

        // Mise à jour du nom choisi et activation du bouton Envoyer
        input.addEventListener('change', function(){
            const fileChosen = input.files && input.files.length > 0;
            const submit = dlg.querySelector('[data-upload-submit]');
            const nameEl = dlg.querySelector('#uploadDialogFileName');
            if (nameEl) {
                nameEl.textContent = fileChosen ? (input.files[0].name || 'Fichier sélectionné') : 'Aucun fichier sélectionné';
                nameEl.title = nameEl.textContent;
            }
            if (submit) submit.disabled = !fileChosen;
        });
    })();

    // Toggle "Réponse en continue" option: updates server and notifies pages
    (function() {
        const toggle = document.getElementById('toggleStreamMode');
        if (!toggle) return;
        const badge = toggle.querySelector('[data-mode-badge]');

        function currentMode() {
            return (toggle.getAttribute('data-chat-mode') || 'chat');
        }

        function setMode(mode) {
            toggle.setAttribute('data-chat-mode', mode);
            if (badge) badge.textContent = mode === 'stream' ? 'On' : 'Off';
            toggle.setAttribute('aria-pressed', String(mode === 'stream'));
            // Notify other parts of the app (e.g., chat.twig)
            window.dispatchEvent(new CustomEvent('chat-mode-changed', { detail: { mode } }));
        }

        async function postMode(mode) {
            try {
                await fetch('{{ base_url }}/config/chat_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ mode })
                });
            } catch (e) {
                // ignore network errors for now
            }
        }

        function toggleClick() {
            const next = currentMode() === 'stream' ? 'chat' : 'stream';
            setMode(next);
            postMode(next);
        }

        toggle.addEventListener('click', toggleClick);
        toggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleClick(); }
        });

        // Initialize ARIA/state on load
        setMode(currentMode());
    })();

    // Toggle "Mode largeur" option: persist like chat mode
    (function() {
        const toggle = document.getElementById('toggleLayoutMode');
        if (!toggle) return;
        const badge = toggle.querySelector('[data-layout-badge]');

        function currentMode() {
            return (toggle.getAttribute('data-layout-mode') || 'full');
        }

        function setMode(mode) {
            toggle.setAttribute('data-layout-mode', mode);
            const isCompact = mode === 'compact';
            document.body.classList.toggle('compact', isCompact);
            if (badge) badge.textContent = isCompact ? 'Largeur 800px' : 'Plein écran';
        }

        async function postMode(mode) {
            try {
                await fetch('{{ base_url }}/config/layout_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ mode })
                });
            } catch (e) {
                // ignore network errors for now
            }
        }

        function toggleClick() {
            const next = currentMode() === 'compact' ? 'full' : 'compact';
            setMode(next);
            postMode(next);
        }

        toggle.addEventListener('click', toggleClick);
        toggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleClick(); }
        });

        // Initialize ARIA/state on load
        setMode(currentMode());
    })();

    // Global fixed tooltip banner for history summaries
    (function() {
        const banner = document.getElementById('historyTooltipBanner');
        if (!banner) return;

        function showBannerFrom(el) {
            if (!el) return;
            const text = el.getAttribute('data-tooltip') || '';
            if (!text) return;
            banner.textContent = text;
            banner.classList.add('is-visible');
            banner.setAttribute('aria-hidden', 'false');
        }

        function hideBanner() {
            banner.classList.remove('is-visible');
            banner.setAttribute('aria-hidden', 'true');
        }

        function wireTooltips(root) {
            const scope = root || document;
            const nodes = scope.querySelectorAll('.history-item__content[data-tooltip]');
            nodes.forEach(function(el) {
                // Avoid double wiring
                if (el.__hasTooltipBanner) return;
                el.__hasTooltipBanner = true;

                el.addEventListener('mouseenter', function() { showBannerFrom(el); });
                el.addEventListener('mouseleave', hideBanner);
                el.addEventListener('focusin', function() { showBannerFrom(el); });
                el.addEventListener('focusout', hideBanner);
                // Touch support: show while touching, hide shortly after
                el.addEventListener('touchstart', function() { showBannerFrom(el); }, { passive: true });
                el.addEventListener('touchend', function() { setTimeout(hideBanner, 120); });
            });
        }

        // Initial wiring
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() { wireTooltips(document); });
        } else {
            wireTooltips(document);
        }

        // Re-wire after HTMX swaps (e.g., when the history list loads/updates)
        window.addEventListener('htmx:afterSwap', function(e) {
            const t = e.target;
            try {
                if (t && (t.id === 'historyList' || (t.closest && t.closest('#historyList')))) {
                    wireTooltips(t);
                }
            } catch (_) { /* no-op */ }
        });
    })();

    // Toggle « Historique des conversations »: clic = ouvre/ferme. Au besoin charge la liste.
    (function () {
        const btn = document.getElementById('historyToggle');
        const panel = document.getElementById('historyList');
        if (!btn || !panel) return;

        function isExpanded() {
            return btn.getAttribute('aria-expanded') === 'true';
        }

        function expand() {
            btn.setAttribute('aria-expanded', 'true');
            // Charger la liste via HTMX
            if (window.htmx) {
                window.htmx.ajax('GET', '{{ base_url }}/history/list', { target: '#historyList', swap: 'innerHTML' });
            }
        }

        function collapse() {
            btn.setAttribute('aria-expanded', 'false');
            // Vider le panneau
            try {
                panel.innerHTML = '';
            } catch (e) {}
        }

        function toggle() {
            if (isExpanded()) {
                collapse();
            } else {
                expand();
            }
        }

        btn.addEventListener('click', function () { toggle(); });
        btn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggle();
            }
        });
    })();

    // Toggle « Fichiers de la conversation »: clic = ouvre/ferme. Charge la liste via HTMX.
    (function () {
        const btn = document.getElementById('filesToggle');
        const panel = document.getElementById('filesList');
        if (!btn || !panel) return;

        function isExpanded() {
            return btn.getAttribute('aria-expanded') === 'true';
        }

        function expand() {
            btn.setAttribute('aria-expanded', 'true');
            if (window.htmx) {
                window.htmx.ajax('GET', '{{ base_url }}/files/list', { target: '#filesList', swap: 'innerHTML' });
            }
        }

        function collapse() {
            btn.setAttribute('aria-expanded', 'false');
            try { panel.innerHTML = ''; } catch (e) {}
        }

        function toggle() {
            if (isExpanded()) { collapse(); } else { expand(); }
        }

        btn.addEventListener('click', function () { toggle(); });
        btn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
        });
    })();
</script>
<script src="{{ base_url }}/js/dialog.js"></script>
</body>
</html>
