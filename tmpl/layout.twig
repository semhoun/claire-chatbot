<!-- index.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Claire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ff3cac">
    <link rel="icon" href="{{ base_url }}/image/icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ base_url }}/css/style.css">
</head>
<body>
<div class="app">
    {% block app %}{% endblock %}

    <!-- Backdrop pour le panneau d'options (fermeture au clic en dehors) -->
    <div class="options-backdrop" id="optionsBackdrop" aria-hidden="true"></div>

    <aside class="options-panel" id="optionsPanel">
        <button
                class="options-close"
                type="button"
                aria-label="Fermer le panneau d’options"
                title="Fermer"
        >
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
        <div class="options-panel__section">
            <span class="options-panel__title">Options</span>
            <div class="options-list">
                <div class="options-item" id="toggleStreamMode" role="button" tabindex="0"
                     aria-pressed="false"
                     data-chat-mode="{{ chat_mode|default('chat') }}"
                >
                    <span class="options-item__label">Réponse en continue</span>
                    <span class="options-item__badge" data-mode-badge>
                        {{ (chat_mode|default('chat')) == 'stream' ? 'On' : 'Off' }}
                    </span>
                </div>
                <div
                        class="options-item"
                        id="historyToggle"
                        role="button"
                        tabindex="0"
                        aria-expanded="false"
                        aria-controls="historyList"
                >
                    <span class="options-item__label">Historique des conversations</span>
                    <span
                            class="options-item__badge"
                            id="historyCountBadge"
                            hx-get="{{ base_url }}/history/count"
                            hx-trigger="load"
                            hx-swap="innerHTML"
                    >0</span>
                </div>
                <div id="historyList" class="options-subpanel" aria-live="polite" style="margin: 0 16px 8px;"></div>
                <div
                        class="options-item"
                        data-layout-toggle
                        hx-on:click="document.body.classList.toggle('compact'); const badge = this.querySelector('[data-layout-badge]'); if (badge) { badge.textContent = document.body.classList.contains('compact') ? 'Largeur 800px' : 'Plein écran'; }"
                >
                    <span class="options-item__label">Mode largeur</span>
                    <span class="options-item__badge" data-layout-badge>Plein écran</span>
                </div>
            </div>
        </div>

        <div class="options-panel__section">
            <span class="options-panel__title">Préférences</span>
            <div class="options-list">
                <div class="options-item">
                    <span class="options-item__label">Notifications</span>
                    <span class="options-item__badge">On</span>
                </div>
                <div class="options-item">
                    <span class="options-item__label">Mode discret</span>
                    <span class="options-item__badge">Off</span>
                </div>
                <div class="options-item">
                    <span class="options-item__label">Langue</span>
                    <span class="options-item__badge">FR</span>
                </div>
            </div>
        </div>

        <div class="options-panel__section">
            <span class="options-panel__title">Compte</span>
            <div class="options-list">
                {% if uinfo is defined and uinfo %}
                <div class="options-item" aria-current="true">
                    <span class="options-item__label">{{ uinfo.name }}</span>
                </div>
                {% endif %}
                <div
                        class="options-item"
                        role="button"
                        tabindex="0"
                        hx-on:click="window.location='{{ base_url }}/logout'"
                        hx-on:keydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); this.click(); }"
                >
                    <span class="options-item__label">Se déconnecter</span>
                </div>
            </div>
        </div>
    </aside>
</div>

<script src="{{ base_url }}/js/htmx.min.js"></script>
<script src="{{ base_url }}/js/htmx-stream.js"></script>
{% block script %}{% endblock %}
<script>
    // Gestion fermeture du panneau d'options (bouton, touche Échap, clic sur backdrop)
    (function() {
        const panel = document.getElementById('optionsPanel');
        const closeBtn = panel ? panel.querySelector('.options-close') : null;
        const toggleBtn = document.querySelector('.options-toggle');
        const backdrop = document.getElementById('optionsBackdrop');
        if (!panel || !closeBtn || !toggleBtn) return;

        function closePanel(focusToggle = true) {
            panel.classList.remove('is-open');
            toggleBtn.classList.remove('is-active');
            toggleBtn.setAttribute('aria-expanded', 'false');
            if (backdrop) { backdrop.classList.remove('is-visible'); }
            if (focusToggle) {
                try { toggleBtn.focus(); } catch (e) {}
            }
        }

        closeBtn.addEventListener('click', function() { closePanel(true); });
        if (backdrop) {
            backdrop.addEventListener('click', function() { closePanel(true); });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.key === 'Esc') {
                if (panel.classList.contains('is-open')) {
                    e.preventDefault();
                    closePanel(true);
                }
            }
        });

        // Si le panneau est ouvert par un autre moyen, s'assurer que aria-expanded est correct
        const observer = new MutationObserver(function() {
            const isOpen = panel.classList.contains('is-open');
            toggleBtn.setAttribute('aria-expanded', String(isOpen));
            if (backdrop) { backdrop.classList.toggle('is-visible', isOpen); }
        });
        observer.observe(panel, { attributes: true, attributeFilter: ['class'] });
    })();

    // Toggle "Réponse en continue" option: updates server and notifies pages
    (function() {
        const toggle = document.getElementById('toggleStreamMode');
        if (!toggle) return;
        const badge = toggle.querySelector('[data-mode-badge]');

        function currentMode() {
            return (toggle.getAttribute('data-chat-mode') || 'chat');
        }

        function setMode(mode) {
            toggle.setAttribute('data-chat-mode', mode);
            if (badge) badge.textContent = mode === 'stream' ? 'On' : 'Off';
            toggle.setAttribute('aria-pressed', String(mode === 'stream'));
            // Notify other parts of the app (e.g., chat.twig)
            window.dispatchEvent(new CustomEvent('chat-mode-changed', { detail: { mode } }));
        }

        async function postMode(mode) {
            try {
                await fetch('{{ base_url }}/config/chat_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ mode })
                });
            } catch (e) {
                // ignore network errors for now
            }
        }

        function toggleClick() {
            const next = currentMode() === 'stream' ? 'chat' : 'stream';
            setMode(next);
            postMode(next);
        }

        toggle.addEventListener('click', toggleClick);
        toggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleClick(); }
        });

        // Initialize ARIA/state on load
        setMode(currentMode());
    })();

    // Toggle « Historique des conversations »: clic = ouvre/ferme. Au besoin charge la liste.
    (function () {
        const btn = document.getElementById('historyToggle');
        const panel = document.getElementById('historyList');
        if (!btn || !panel) return;

        function isExpanded() {
            return btn.getAttribute('aria-expanded') === 'true';
        }

        function expand() {
            btn.setAttribute('aria-expanded', 'true');
            // Charger la liste via HTMX
            if (window.htmx) {
                window.htmx.ajax('GET', '{{ base_url }}/history/list', { target: '#historyList', swap: 'innerHTML' });
            }
        }

        function collapse() {
            btn.setAttribute('aria-expanded', 'false');
            // Vider le panneau
            try {
                panel.innerHTML = '';
            } catch (e) {}
        }

        function toggle() {
            if (isExpanded()) {
                collapse();
            } else {
                expand();
            }
        }

        btn.addEventListener('click', function () { toggle(); });
        btn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggle();
            }
        });
    })();
</script>
</body>
</html>
